<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RailFence CipherLab</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>RailFence CipherLab</h1>
    <p>レールフェンス暗号を視覚的に学ぶツール</p>
  </header>

  <div class="tabs">
    <button class="tab-button active" data-tab="encrypt">暗号化</button>
    <button class="tab-button" data-tab="decrypt">復号</button>
    <button class="tab-button" data-tab="study">座学</button>
    <button class="tab-button" data-tab="lab">実験室</button>
  </div>

  <div class="tab-content" id="encrypt">
    <h2>暗号化</h2>
    <div class="sample-buttons">
      <button class="sample-btn" onclick="loadSample(1)">サンプル1</button>
      <button class="sample-btn" onclick="loadSample(2)">サンプル2</button>
      <button class="sample-btn" onclick="clearText()">クリア</button>
    </div>
    <textarea id="plaintext" rows="4" placeholder="平文を入力してください"></textarea>
    <div id="warning-area"></div>
    <label><input type="checkbox" id="removeSpace" /> 空白を除いて処理する</label>
    <label><input type="checkbox" id="removeSymbol" /> 記号を除いて処理する</label>

    <div>
      <label>レール数:
        <select id="railCount">
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
        </select>
      </label>
      <label>方式:
        <select id="method">
          <option value="sequential">方式1（順次）</option>
          <option value="zigzag">方式2（交互）</option>
        </select>
      </label>
    </div>

    <label>
      <input type="checkbox" id="realtimeMode" checked> リアルタイム暗号化
    </label>
    <button id="encryptBtn" onclick="encrypt()" disabled>暗号化する</button>
    
    <div class="readonly-box" id="cleanedText"></div>
    
    <div id="animationControls" class="animation-controls hidden">
      <button id="playBtn" onclick="toggleAnimation()">▶ 再生</button>
      <button onclick="resetAnimation()">⏹ リセット</button>
      <label>速度:
        <input type="range" id="animationSpeed" min="100" max="2000" value="100" step="100" title="右に動かすとゆっくり、左に動かすと速くなります">
        <span id="speedDisplay">100ms</span>
      </label>
    </div>
    
    <div id="railDisplay"></div>
    <div class="readonly-box" id="intermediateText"></div>
    <div id="cipherResult"></div>
    
    <div id="exportControls" class="export-controls hidden">
      <button onclick="exportAsImage()">📷 画像で保存</button>
      <button onclick="exportAsText()">📄 テキストで保存</button>
      <button onclick="printRailGrid()">🖨 印刷</button>
    </div>
  </div>

  <div class="tab-content hidden" id="decrypt">
    <h2>復号</h2>
    
    <div class="sync-controls-top">
      <button id="syncFromEncrypt" onclick="syncFromEncryptTab()">🔄 暗号化タブの設定を同期</button>
      <span id="syncStatus" class="sync-status"></span>
    </div>
    
    <div class="sample-buttons">
      <button class="sample-btn" onclick="loadDecryptSample(1)">サンプル1</button>
      <button class="sample-btn" onclick="loadDecryptSample(2)">サンプル2</button>
      <button class="sample-btn" onclick="clearDecryptText()">クリア</button>
    </div>
    <textarea id="ciphertext" rows="4" placeholder="暗号文を入力してください"></textarea>
    <div id="decryptWarningArea"></div>
    
    <div>
      <label>レール数:
        <select id="decryptRailCount">
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
        </select>
      </label>
      <label>方式:
        <select id="decryptMethod">
          <option value="sequential">方式1（順次）</option>
          <option value="zigzag">方式2（交互）</option>
        </select>
      </label>
    </div>

    <label>
      <input type="checkbox" id="decryptRealtimeMode" checked> リアルタイム復号
    </label>
    <button id="decryptBtn" onclick="decrypt()" disabled>復号する</button>
    
    <div id="decryptAnimationControls" class="animation-controls hidden">
      <button id="decryptPlayBtn" onclick="toggleDecryptAnimation()">▶ 再生</button>
      <button onclick="resetDecryptAnimation()">⏹ リセット</button>
      <label>速度:
        <input type="range" id="decryptAnimationSpeed" min="100" max="2000" value="100" step="100" title="右に動かすとゆっくり、左に動かすと速くなります">
        <span id="decryptSpeedDisplay">100ms</span>
      </label>
    </div>
    <div id="decryptDisplay"></div>
    <div class="readonly-box" id="decryptIntermediateText"></div>
    <div id="plainResult"></div>
    
    <div id="decryptExportControls" class="export-controls hidden">
      <button onclick="exportDecryptAsImage()">📷 画像で保存</button>
      <button onclick="exportDecryptAsText()">📄 テキストで保存</button>
      <button onclick="printDecryptRailGrid()">🖨 印刷</button>
    </div>
  </div>

  <div class="tab-content hidden" id="study">
    <h2>レールフェンス暗号とは？</h2>
    <p>転置暗号の一種で、文字をレール状に並べて並び順を変えることで暗号化します。</p>
    <ul>
      <li>方式1は縦列転置暗号と同じ構造を持ちます。</li>
      <li>方式2は文字を上下交互に移動させる蛇行構造です。</li>
      <li>復号は文字の配置構造を再現する必要があるため、暗号化よりもやや複雑です。</li>
      <li>解読の際には、レール数・方式・開始位置など不明点が多く、総当たりが有効な手段になります。</li>
      <li>冗字があると復元精度が下がる場合があります。</li>
    </ul>
  </div>

  <div class="tab-content hidden" id="lab">
    <h2>実験室</h2>
    <p>レールフェンス暗号の様々な実験を行うことができます。</p>
    
    <div class="experiment-section">
      <h3>🔬 総当たり解読実験</h3>
      <p>暗号文に対して様々なレール数・方式で復号を試行し、可能性のある平文を表示します。</p>
      <div class="experiment-info">
        <details>
          <summary>📊 スコアリング方式について</summary>
          <ul>
            <li><strong>母音比率:</strong> 自然な言語の母音比率（20-60%）に近いほど高得点</li>
            <li><strong>連続文字:</strong> 同じ文字の連続が少ないほど高得点</li>
            <li><strong>単語パターン:</strong> 一般的な英単語や日本語パターンを含むほど高得点</li>
            <li><strong>空白・記号:</strong> 適度な空白や記号があるほど高得点</li>
          </ul>
          <p><small>※ スコアは参考値です。実際の解読では文脈も重要な判断材料となります。</small></p>
        </details>
      </div>
      
      <div class="experiment-input">
        <label>解読したい暗号文:</label>
        <textarea id="labCiphertext" rows="3" placeholder="解読したい暗号文を入力してください"></textarea>
      </div>
      
      <div class="experiment-controls">
        <label>試行するレール数:
          <select id="labRailRange">
            <option value="2-6">2-6レール</option>
            <option value="2-3">2-3レール</option>
            <option value="2-4">2-4レール</option>
            <option value="3-5">3-5レール</option>
            <option value="4-6">4-6レール</option>
          </select>
        </label>
        <label>
          <input type="checkbox" id="labBothMethods" checked> 両方式を試行
        </label>
      </div>
      
      <button id="bruteForceBtn" onclick="performBruteForce()">🔍 総当たり解読開始</button>
      
      <div id="bruteForceResults" class="experiment-results"></div>
    </div>
    
    <div class="experiment-section">
      <h3>📊 統計実験</h3>
      <p>異なる設定での暗号化パターンを比較分析します。</p>
      <div class="experiment-info">
        <details>
          <summary>🔍 この実験で分かること</summary>
          <ul>
            <li><strong>最適な鍵の選択:</strong> 入力した平文に対して、どのレール数・方式が最も効果的に元の文字順序を隠蔽するかを比較</li>
            <li><strong>文字の移動距離:</strong> 各設定で文字がどれだけ元の位置から移動するかを数値化（大きいほど安全）</li>
            <li><strong>エントロピー変化:</strong> 暗号化により文字分布がどれだけランダムになるかを測定</li>
            <li><strong>セキュリティレベル:</strong> 文字長や内容に応じた最適な暗号化強度の判定</li>
          </ul>
          <p><small>💡 <strong>実用例:</strong> 短いメッセージには高いレール数、長いメッセージには方式2（交互）が効果的な場合が多いです。</small></p>
        </details>
      </div>
      
      <div class="experiment-input">
        <label>分析したい平文:</label>
        <textarea id="labPlaintext" rows="3" placeholder="分析したい平文を入力してください"></textarea>
      </div>
      
      <button onclick="performStatistics()">📈 統計分析開始</button>
      
      <div id="statisticsResults" class="experiment-results"></div>
    </div>
  </div>

  <footer>
    <div class="footer">
      🔗 GitHubリポジトリはこちら（ <a href="https://github.com/ipusiron/railfence-cipherlab" target="_blank">ipusiron/railfence-cipherlab</a> ）
    </div>
  </footer>

  <script src="js/common.js"></script>
  <script src="js/encrypt.js"></script>
  <script src="js/decrypt.js"></script>
  <script src="js/lab.js"></script>
</body>
</html>
